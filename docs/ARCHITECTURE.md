# System Architecture - Speaker/Listener Mode

## High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FLASK SERVER (app.py)                        â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  HTTP Routes     â”‚  â”‚  Socket.IO      â”‚  â”‚  Session         â”‚  â”‚
â”‚  â”‚  /speaker        â”‚  â”‚  Rooms          â”‚  â”‚  Management      â”‚  â”‚
â”‚  â”‚  /listener/{id}  â”‚  â”‚  Broadcasting   â”‚  â”‚  Storage         â”‚  â”‚
â”‚  â”‚  /api/*          â”‚  â”‚  Tracking       â”‚  â”‚  {id: {...}}     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Azure Speech SDK Integration                      â”‚  â”‚
â”‚  â”‚  â€¢ TranslationRecognizer (Microphone â†’ Translation)           â”‚  â”‚
â”‚  â”‚  â€¢ SpeechSynthesizer (Translation â†’ Avatar Speech)            â”‚  â”‚
â”‚  â”‚  â€¢ WebRTC Connection (Avatar Video Stream)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†•
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Azure Speech Service       â”‚
                    â”‚  â€¢ Speech Recognition         â”‚
                    â”‚  â€¢ Translation                â”‚
                    â”‚  â€¢ Avatar Synthesis (WebRTC)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†•
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                    â”‚
        â†“                                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SPEAKER UI     â”‚                            â”‚   LISTENER UI    â”‚
â”‚  (speaker.html)  â”‚                            â”‚  (listener.html) â”‚
â”‚                  â”‚                            â”‚                  â”‚
â”‚  â€¢ Session Mgmt  â”‚                            â”‚  â€¢ Avatar Video  â”‚
â”‚  â€¢ Controls      â”‚                            â”‚  â€¢ Translation   â”‚
â”‚  â€¢ Transcription â”‚                            â”‚  â€¢ History       â”‚
â”‚  â€¢ Listener Countâ”‚                            â”‚  â€¢ Audio Visual  â”‚
â”‚                  â”‚                            â”‚                  â”‚
â”‚  NO AVATAR       â”‚                            â”‚  NO CONTROLS     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†•                                                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   speaker.js     â”‚                            â”‚   listener.js    â”‚
â”‚                  â”‚                            â”‚                  â”‚
â”‚  â€¢ Session API   â”‚                            â”‚  â€¢ WebRTC Setup  â”‚
â”‚  â€¢ Socket.IO     â”‚                            â”‚  â€¢ Socket.IO     â”‚
â”‚  â€¢ UI Updates    â”‚                            â”‚  â€¢ UI Updates    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Session Flow Diagram

```
PHASE 1: SESSION CREATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Speaker                    Server                    Storage
  â”‚                          â”‚                          â”‚
  â”‚  POST /api/createSession â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                          â”‚  Generate 6-digit code   â”‚
  â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚                          â”‚
  â”‚                          â”‚  Store session config    â”‚
  â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                          â”‚                          â”‚
  â”‚  {sessionId, URL, ...}   â”‚                          â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚                          â”‚                          â”‚
  â”‚  Display session info    â”‚                          â”‚
  â”‚  Show listener URL       â”‚                          â”‚
  â”‚                          â”‚                          â”‚


PHASE 2: LISTENER JOINS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Listener                   Server                    Speaker
  â”‚                          â”‚                          â”‚
  â”‚  GET /listener/123456    â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                          â”‚  Validate session        â”‚
  â”‚                          â”‚                          â”‚
  â”‚  listener.html + config  â”‚                          â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚                          â”‚                          â”‚
  â”‚  Socket.IO connect       â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                          â”‚                          â”‚
  â”‚  emit('joinSession')     â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                          â”‚  Add to session room     â”‚
  â”‚                          â”‚  Track listener SID      â”‚
  â”‚                          â”‚                          â”‚
  â”‚                          â”‚  emit('listenerJoined')  â”‚
  â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚                          â”‚
  â”‚                          â”‚  Update listener count   â”‚
  â”‚                          â”‚                          â”‚
  â”‚  POST /api/connect...    â”‚                          â”‚
  â”‚  Avatar (WebRTC SDP)     â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                          â”‚  Connect to Azure Avatar â”‚
  â”‚                          â”‚                          â”‚
  â”‚  {sdp: "...answer"}      â”‚                          â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚                          â”‚                          â”‚
  â”‚  WebRTC connection       â”‚                          â”‚
  â”‚  established             â”‚                          â”‚
  â”‚                          â”‚                          â”‚


PHASE 3: TRANSLATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Speaker                    Server                    Listeners (All)
  â”‚                          â”‚                          â”‚
  â”‚  POST /api/start...      â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                          â”‚  Start TranslationRec    â”‚
  â”‚                          â”‚  Link to session         â”‚
  â”‚                          â”‚                          â”‚
  â”‚  {status: "started"}     â”‚                          â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚                          â”‚                          â”‚
  â”‚  ğŸ¤ Speak into mic       â”‚                          â”‚
  â”‚                          â”‚                          â”‚
  â”‚  Audio stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  Recognize speech      â”‚
  â”‚                          â”‚  Translate to target    â”‚
  â”‚                          â”‚  Generate SSML          â”‚
  â”‚                          â”‚                          â”‚
  â”‚                          â”‚  For each listener:     â”‚
  â”‚                          â”‚  Synthesize avatar      â”‚
  â”‚                          â”‚  Stream via WebRTC      â”‚
  â”‚                          â”‚                          â”‚
  â”‚                          â”‚  Broadcast to room:     â”‚
  â”‚                          â”‚  emit('translationResult')
  â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚  (speaker also receives) â”‚                          â”‚
  â”‚                          â”‚                          â”‚
  â”‚  Update transcription    â”‚  Update UI               â”‚
  â”‚  Add to history          â”‚  ğŸ—£ï¸ Avatar speaks       â”‚
  â”‚                          â”‚  Add to history          â”‚
  â”‚                          â”‚                          â”‚
  [Loop continues for each speech segment]
  â”‚                          â”‚                          â”‚


PHASE 4: SESSION END
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Speaker                    Server                    Listeners (All)
  â”‚                          â”‚                          â”‚
  â”‚  POST /api/endSession    â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                          â”‚  Stop translation        â”‚
  â”‚                          â”‚  Broadcast to session:   â”‚
  â”‚                          â”‚  emit('sessionEnded')    â”‚
  â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚                          â”‚
  â”‚                          â”‚  Remove from storage     â”‚
  â”‚                          â”‚  Clean up listeners      â”‚
  â”‚                          â”‚                          â”‚
  â”‚  {status: "ended"}       â”‚                          â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚                          â”‚                          â”‚
  â”‚  UI resets               â”‚  Show "Session ended"    â”‚
  â”‚                          â”‚  Disconnect avatar       â”‚
  â”‚                          â”‚                          â”‚
```

## WebRTC Avatar Connection Flow

```
Listener                Azure Avatar Service         Listener Browser
  â”‚                            â”‚                            â”‚
  â”‚  1. Create PeerConnection  â”‚                            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
  â”‚  (with ICE config)         â”‚                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  2. Add transceivers       â”‚                            â”‚
  â”‚  (video, audio)            â”‚                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  3. Create SDP offer       â”‚                            â”‚
  â”‚  (local description)       â”‚                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  4. Wait for ICE gathering â”‚                            â”‚
  â”‚  (10 second timeout)       â”‚                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  5. POST /api/connectListener...                        â”‚
  â”‚  {sdp: "offer", ...}       â”‚                            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                            â”‚
  â”‚                            â”œâ”€â”€â”€â”€ Connect to Azure â”€â”€â”€â”€â”€>
  â”‚                            â”‚                            â”‚
  â”‚                            â”‚  Process SDP offer         â”‚
  â”‚                            â”‚  Prepare avatar stream     â”‚
  â”‚                            â”‚                            â”‚
  â”‚                            â”‚<â”€â”€â”€ SDP answer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚  {sdp: "answer"}           â”‚                            â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  6. Set remote description â”‚                            â”‚
  â”‚  (answer from Azure)       â”‚                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  7. ICE candidates exchange                             â”‚
  â”‚  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â”‚                            â”‚                            â”‚
  â”‚  8. Connection established â”‚                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  9. Receive media tracks   â”‚                            â”‚
  â”‚  (video + audio)           â”‚                            â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                            â”‚                            â”‚
  â”‚  10. Play in <video> element                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  âœ… Avatar video playing   â”‚                            â”‚
  â”‚                            â”‚                            â”‚
```

## Socket.IO Room Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Socket.IO Server                          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Session Room: "123456"                                   â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  Members:                                                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ Speaker        â”‚  â”‚ Listener 1     â”‚  â”‚ Listener 2 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ SID: abc123    â”‚  â”‚ SID: def456    â”‚  â”‚ SID: ghi789â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ Role: speaker  â”‚  â”‚ Role: listener â”‚  â”‚ Role: list.â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  Broadcasted Events:                                       â”‚ â”‚
â”‚  â”‚  â€¢ translationResult  â”€â”€â”€â”€â”€â”€â”€> All members                â”‚ â”‚
â”‚  â”‚  â€¢ listenerJoined     â”€â”€â”€â”€â”€â”€â”€> All members                â”‚ â”‚
â”‚  â”‚  â€¢ listenerCountUpdated â”€â”€â”€â”€â”€> All members                â”‚ â”‚
â”‚  â”‚  â€¢ sessionEnded       â”€â”€â”€â”€â”€â”€â”€> All members                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Session Room: "789012"                                   â”‚ â”‚
â”‚  â”‚  (Another concurrent session)                             â”‚ â”‚
â”‚  â”‚  Members: [...]                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow - Single Translation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SPEAKER SPEAKS: "Hello, how are you?"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. MICROPHONE CAPTURE                                           â”‚
â”‚     â€¢ Browser getUserMedia API                                   â”‚
â”‚     â€¢ Audio stream to Azure Speech SDK                           â”‚
â”‚     â€¢ ~50ms buffer                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. SPEECH RECOGNITION (Azure)                                   â”‚
â”‚     â€¢ Language: en-US                                            â”‚
â”‚     â€¢ Result: "Hello, how are you?"                              â”‚
â”‚     â€¢ Confidence: 0.95                                           â”‚
â”‚     â€¢ ~500ms latency                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. TRANSLATION (Azure)                                          â”‚
â”‚     â€¢ Source: "Hello, how are you?"                              â”‚
â”‚     â€¢ Target language: es-ES                                     â”‚
â”‚     â€¢ Result: "Hola, Â¿cÃ³mo estÃ¡s?"                               â”‚
â”‚     â€¢ ~100ms latency                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. SSML GENERATION (Server)                                     â”‚
â”‚     â€¢ Voice: es-ES-ElviraNeural                                  â”‚
â”‚     â€¢ SSML: <speak>...</speak>                                   â”‚
â”‚     â€¢ Leading silence: 0ms                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. AVATAR SYNTHESIS (Azure)                                     â”‚
â”‚     â€¢ Text-to-Speech with avatar                                 â”‚
â”‚     â€¢ Video: H.264, 1920x1080 â†’ cropped                          â”‚
â”‚     â€¢ Audio: Opus codec                                          â”‚
â”‚     â€¢ ~300ms latency                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ WebRTC  â”‚  (Video + Audio stream)
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚
        â†“                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LISTENER 1     â”‚            â”‚  LISTENER 2     â”‚
â”‚  ğŸ—£ï¸ Avatar plays â”‚            â”‚  ğŸ—£ï¸ Avatar plays â”‚
â”‚  "Hola, Â¿cÃ³mo   â”‚            â”‚  "Hola, Â¿cÃ³mo   â”‚
â”‚   estÃ¡s?"       â”‚            â”‚   estÃ¡s?"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. SOCKET.IO BROADCAST (Server â†’ All in session)               â”‚
â”‚     â€¢ Event: "translationResult"                                 â”‚
â”‚     â€¢ Data: {                                                    â”‚
â”‚         sourceText: "Hello, how are you?",                       â”‚
â”‚         translatedText: "Hola, Â¿cÃ³mo estÃ¡s?",                    â”‚
â”‚         timestamp: "2024-01-15T10:30:00Z"                        â”‚
â”‚       }                                                          â”‚
â”‚     â€¢ Sent to: Speaker + All Listeners                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚
        â†“                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SPEAKER UI     â”‚            â”‚  LISTENER UI    â”‚
â”‚                 â”‚            â”‚                 â”‚
â”‚  ğŸ“ Source:     â”‚            â”‚  ğŸ“ Source:     â”‚
â”‚  "Hello..."     â”‚            â”‚  "Hello..."     â”‚
â”‚                 â”‚            â”‚                 â”‚
â”‚  ğŸ“ Target:     â”‚            â”‚  ğŸ“ Target:     â”‚
â”‚  "Hola..."      â”‚            â”‚  "Hola..."      â”‚
â”‚                 â”‚            â”‚                 â”‚
â”‚  ğŸ“œ History +1  â”‚            â”‚  ğŸ“œ History +1  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Total End-to-End Latency: ~1-1.5 seconds
```

## Session State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   INITIAL    â”‚  (No session exists)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ POST /api/createSession
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CREATED    â”‚  (Session exists, not active)
â”‚   active:    â”‚  â€¢ Has session ID
â”‚   false      â”‚  â€¢ Has configuration
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ Listener URL generated
       â”‚          â€¢ No speaker client linked
       â”‚ Listeners can join
       â”‚ and connect avatars
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WAITING     â”‚  (Listeners connected, waiting)
â”‚              â”‚  â€¢ Listeners: 1-N
â”‚              â”‚  â€¢ Avatars ready
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ No translation yet
       â”‚
       â”‚ POST /api/startTranslation
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ACTIVE     â”‚  (Translation in progress)
â”‚   active:    â”‚  â€¢ Speaker speaking
â”‚   true       â”‚  â€¢ Translations broadcasting
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ Avatars speaking
       â”‚          â€¢ History building
       â”‚
       â”‚ POST /api/stopTranslation
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PAUSED     â”‚  (Translation stopped, session alive)
â”‚   active:    â”‚  â€¢ Listeners still connected
â”‚   false      â”‚  â€¢ Can resume translation
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ History preserved
       â”‚
       â”‚ POST /api/startTranslation (again)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ACTIVE     â”‚  (Back to translation)
â”‚   (resumed)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ POST /api/endSession
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ENDED      â”‚  (Session terminated)
â”‚              â”‚  â€¢ Listeners notified
â”‚              â”‚  â€¢ Removed from storage
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ Cannot be resumed

State Transitions:
â€¢ CREATED â†’ WAITING: First listener joins
â€¢ WAITING â†’ ACTIVE: Speaker starts translation
â€¢ ACTIVE â†’ PAUSED: Speaker stops translation
â€¢ PAUSED â†’ ACTIVE: Speaker resumes translation
â€¢ Any â†’ ENDED: Speaker ends session
â€¢ ENDED â†’ (deleted): No recovery possible
```

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ERROR SCENARIOS                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Session Creation Fails
   Speaker â†’ POST /api/createSession
          â† {error: "message"}
   Action: Show error, allow retry

2. Session Not Found
   Listener â†’ GET /listener/999999
           â† 404 Session not found
   Action: Show error page, suggest checking URL

3. Avatar Connection Fails
   Listener â†’ POST /api/connectListenerAvatar
           â† {error: "WebRTC failed"}
   Action: Show "Connection failed", retry button

4. Microphone Access Denied
   Speaker â†’ Start translation
          â† Browser blocks getUserMedia()
   Action: Show "Microphone required", instructions

5. Translation Recognizer Error
   Server â†’ TranslationRecognizer.canceled event
   Action: Log error, notify speaker, allow restart

6. Socket.IO Disconnect
   Client â†’ Connection lost
   Action: Auto-reconnect (3 attempts), show status

7. Session Ended Mid-Translation
   Server â†’ emit('sessionEnded')
   Listeners â† Receive event
   Action: Show notification, stop UI updates

8. Multiple Browser Tabs (Same Listener)
   New tab â†’ Same listener URL
   Action: Allow (independent connections)

9. Server Restart
   All sessions â†’ Lost (in-memory)
   Clients â†’ 404 on next request
   Action: Show "Session expired", return to home
```

---

**End of Architecture Documentation**

For implementation details, see:
- `IMPLEMENTATION_SUMMARY.md` - Code details
- `SPEAKER_LISTENER_GUIDE.md` - Usage guide
- `app.py` - Backend implementation
- `speaker.js` / `listener.js` - Frontend logic
